@page
@model ChemicalLaboratory.Pages.Add.UpdateExperimentModel
@{
	Layout = "_Layout1";
    bool isAdmin = User.IsInRole("Администратор");
}

@if (TempData["EmailNotification"] != null)
{
    <div class="notification-popup">
        @TempData["EmailNotification"]
    </div>
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет пользователя</title>
    <link href="~/css/UpdateExperiment.css" rel="stylesheet"/>
    <style>

        /* Кнопки действия в таблице */
        .action-buttons {
            display: flex;
            justify-content: left; /* Центрируем кнопки по горизонтали */
        }

            .action-buttons button {
                padding: 6px 10px;
                font-size: 0.8em;
                margin: 0 4px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

                .action-buttons button.delete {
                    background-color: #e74c3c;
                    color: white;
                }

                    .action-buttons button.delete:hover {
                        background-color: #c0392b;
                    }

                .action-buttons button.update {
                    background-color: #27ae60;
                    color: white;
                }

                    .action-buttons button.update:hover {
                        background-color: #229954;
                    }

        .header-container {
            display: flex;
            align-items: center; /* Выравнивает элементы по центру по вертикали */
        }

            .header-container h3 {
                margin: 0; /* Убирает отступы */
            }

            .header-container h2 {
                justify-content: left; /* Добавляет пространство между элементами */
            }

            .header-container button {
                justify-content: right; /* Добавляет пространство между элементами */
                margin-right: 10px; /* Располагает кнопку слева от правого края */
                margin-left: auto;
            }

        .mycontainer {
            max-width: 1500px;
            margin: 20px auto;
            display: flex;
            gap: 20px;
            background: white;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .experiment-column {
            flex: 2;
        }

        h1, h2 {
            text-align: center;
            color: #333;
        }

        .user-info {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

            .user-info div {
                font-size: 1rem;
            }

        .tabs {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #ddd;
        }

            .tab-buttons button {
                flex: 1;
                padding: 10px;
                cursor: pointer;
                background: #f9f9f9;
                border: none;
                outline: none;
                border-right: 1px solid #ddd;
                font-size: 1rem;
            }

                .tab-buttons button:last-child {
                    border-right: none;
                }

                .tab-buttons button.active {
                    background: #1877f2;
                    color: white;
                }

        .tab-content {
            display: none;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-top: 10px;
        }

            .tab-content.active {
                display: block;
            }

        .experiment-details .element {
            margin-top: 10px;
            margin-bottom: 10px;
            display: flex
        }

            .experiment-details .element .el2 {
		    	margin-left: auto;
                align-content: center;
		    }

        .experiment-details span {
            font-weight: bold;
        }
        /* Начало отсюда*/
        .experiment-column {
            padding: 20px;
            border: 1px solid #ccc;
        }

        .experiment-details {
            margin-bottom: 20px;
        }

        .tabs-container {
            display: flex;
            flex-direction: column;
            height: 300px; /* Вы можете настроить высоту контейнера, если необходимо */
            justify-content: space-between;
        }

        .tabs {
            margin-top: auto; /* Сдвигает вкладки в самый низ */
        }

        .tab-buttons {
            display: flex;
            justify-content: space-around;
            border-top: 1px solid #ddd;
            padding: 10px 0;
        }

        .tab-btn {
            padding: 10px;
            cursor: pointer;
            background: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: background 0.3s;
        }

            .tab-btn:hover {
                background: #ddd;
            }

            .tab-btn.active {
                background: #ccc;
            }

        .tab-content {
            display: none;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

            .tab-content.active {
                display: block;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }

        th {
            background-color: #f1f1f1;
        }


        /* Стили для полей в режиме readonly */
        input[readonly] {
            background-color: #f9f9f9; /* Светло-серый фон */
            color: #555; /* Темно-серый текст */
            cursor: not-allowed; /* Курсор "не доступен" */
            border: 1px solid #ddd; /* Светлая рамка */
            border-radius: 4px; /* Закругленные края */
            padding: 5px; /* Внутренний отступ */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); /* Внутренняя тень */
            font-size: 1.0rem; /* Увеличенный размер текста */
            font-weight: bold; /* Обычный шрифт для readonly */
        }

        /* Стили для активных (редактируемых) полей */
        input:not([readonly]) {
            background-color: #fff; /* Белый фон */
            color: #000; /* Черный текст */
            border: 1px solid #ccc; /* Обычная рамка */
            border-radius: 4px;
            padding: 5px;
            box-shadow: none; /* Убираем тень */
            font-size: 1.0rem; /* Увеличенный размер текста */
            font-weight: normal; /* Полужирный текст */
        }

        /* Стили для label */
        label {
            font-weight: bold; /* Жирный шрифт */
            font-size: 1.1rem; /* Размер текста для label */
            margin-bottom: 5px; /* Отступ между label и input */
        }
        
    </style>
</head>

<body>
    <div class="mycontainer">

        <!-- Правая колонка с экспериментом -->
        <div class="experiment-column">
            <form method="post">
                <div class="header-container">
                    <h2>Информация об "@Model.Experiment.Name"</h2>                    
                </div>

                <div class="experiment-details">

                    <div class="element">
                        <label for="ExperimentName">Название:</label>
						<input id="ExperimentName" value="@Model.Experiment.Name" name="ExperimentName" @(isAdmin ? "" : "readonly") /> <!---->
                        <div class="el2">
                            <select asp-for="reportId">

                                <option value=0>Отчет в Excel</option>
                                <option value=1>Отчет в PDF</option>
                                <option value=2>Отчет в XML</option>
                                <option value=3>Отчет в JSON</option>

                            </select>
                        </div>
                    </div>

                    <div class ="element">
                        <label for="ExperimentDescription">Описание:</label>
                        <input id="ExperimentDescription" name="ExperimentDescription" value="@Model.Experiment.Description" @(isAdmin ? "" : "readonly") />
                        <div class="el2">
                            <button name="action" asp-page-handler="Export" value=@Model.Experiment.idExperiment type="submit">Сформировать отчет</button><!-- onclick=" saveForm(this)-->
                        </div>
                    </div>

                    <div class="element">
                        <label for="ExperimentStartDate">Начало:</label>
                        <input id="ExperimentStartDate" type="datetime-local" name="ExperimentStartDate" value="@Model.Experiment.StartDate?.ToString("yyyy-MM-ddTHH:mm")" @(isAdmin ? "" : "readonly")  />

                        @if (User.IsInRole("Администратор"))
                        {
                            <div class="el2">
                                <button name="action" onclick="saveForm(this)" type="button">Сохранить изменения</button> <!--asp-page-handler="SaveDate"-->
                            </div>
                        }
                    </div>

                    <div class="element">
                        <label for="ExperimentEndDate">Конец:</label>
                        <input id="ExperimentEndDate" type="datetime-local" name="ExperimentEndDate" value="@Model.Experiment.EndDate?.ToString("yyyy-MM-ddTHH:mm")" @(isAdmin ? "" : "readonly") />
                    </div>

                    <div class="element">
                        <label for="ExperimentResult">Результат:</label>
                        <input id="ExperimentResult" name="ExperimentResult" value="@Model.Experiment.Result" @(isAdmin ? "" : "readonly") />
                    </div>

                    <div class="element">
                        <label for="ExperimentStatus">Статус:</label>
						<!--<input id="ExperimentStatus" name="ExperimentStatus" value="Model.Experiment.Status" (isAdmin ? "" : "readonly") />-->
                        <select name="ExperimentStatus" id="ExperimentStatus" value="@Model.Experiment.Status" @(isAdmin ? "" : "readonly")>

                            <option value="@Model.Experiment.Status">@Model.Experiment.Status</option>
                            <option value="В процессе">В процессе</option>
                            <option value="Завершен">Завершен</option>
                            <option value="Запланирован">Запланирован</option>
                            <option value="Отменен">Отменен</option>
                            <option value="Приостановлен">Приостановлен</option>

                        </select>
                    </div>

                </div>
            </form>

            <!-- Контейнер для табов (вкладок) и контента -->
            
            <div class="tabs-container">
                <div class="tabs">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="showTab(0)">Оборудование</button>
                        <button class="tab-btn" onclick="showTab(1)">Реагенты</button>
                    </div>
                </div>

                <!-- Контент вкладок -->
                <div class="tab-content active">

					<form method="get">
                        <div class="header-container">
                            <h3>Используемое оборудование</h3>
                            <!--<button name="action" value="equipment" type="submit"  class="delete">Добавить оборудование</button>-->
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Модель</th>
                                    <th>Описание</th>
                                    <th>Вид</th>
                                    <th>Статус</th>
                                    @if (User.IsInRole("Администратор"))
                                    {
                                        <th class="sticky-column">Действия</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                 @foreach (var item in Model.Equipment)
                                 {
                                    <tr>
                                        <td>@item.Name</td>
                                        <td>@item.Model</td>
                                        <td>@item.Description</td>
                                        <td>@item.Kind</td>
                                        <td>@item.Status</td>
                                       @if (User.IsInRole("Администратор"))
                                       {
                                           <td class="action-buttons">
                                               <!--<button type="button" name="Update" class="update" value=item.idEquipment onclick="editRow(this)">Изменить</button>-->
                                               <button type="submit" name="DeleteReagent" class="delete" value=@item.idEquipment>Удалить</button>
                                           </td>
                                       }
                                    </tr>
                                 }
                            </tbody>
                        </table>
					</form>

                    <form method="post">
                        @if (User.IsInRole("Администратор"))
                        {
                            <select name="EquipmentId" id="EquipmentId">
                                <option value="0">Нет оборудования</option>
                                @foreach (var option in Model.EquipmentList)
                                {
                                    <option value="@option.Value">@option.Text</option>
                                }
                            </select>
                            <button type="submit" asp-page-handler="NewEquip">Добавить</button>
                        }
                    </form>
                    

                </div>
                <div class="tab-content" data-tab="reagents">

                    <form method="get">
                        <div class="header-container">
					    	<h3>Используемые реагенты</h3>
                            <!--<button name="action" value="reagent" type="submit" class="delete">Добавить реагент</button>-->
                        </div>

                    
                        <table class="target-table">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Химическая формула</th>
                                    <th>Плотность</th>
                                    <th>Использованная масса</th>
                                    <th>Количество использованного реагента</th>
                                    @if (User.IsInRole("Администратор"))
                                    {
                                        <th class="sticky-column">Действия</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                <!--Model.UserProfile.Reagent.idReagentDataModel.Reagent.Name - по моему что-то не так -->
                                @foreach (var reagent in Model.Reagent)
                                {
                                    @if (reagent.idReagentDataModel.Reagent.idReagent != 0)
                                    {
                                        <tr>
                                            <td>@reagent.idReagentDataModel.Reagent.Name</td>
                                            <td>@reagent.idReagentDataModel.Reagent.ChemicalFormula</td>
                                            <td>@reagent.idReagentDataModel.Reagent.Dansity</td>
                                            <td>@reagent.Mass</td>
                                            <td>@reagent.UseCount</td>
                                            @if (User.IsInRole("Администратор"))
                                            {
                                                <td class="action-buttons">
					    							<button type="button" name="Update" onclick="editRow(this)" class="update" value=@reagent.idReagentExperiment>Изменить</button><!---->
                                                    <button type="submit" name="DeleteReagent"  value =@reagent.idReagentExperiment class="delete">Удалить</button> <!--name="Delete"value=reagent.idReagentExperiment-->
                                                </td>
                                            }
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
					</form>

                    <form method="post">
					    @if (User.IsInRole("Администратор"))
                        {
                            <select name="ReagentId" id="ReagentId">
                                <option value="0">Нет реагентов</option>
                                @foreach (var option in Model.ReagentList)
                                {
                                    <option value="@option.Value">@option.Text</option>
                                }
                            </select>
                            <button type="submit" asp-page-handler="NewReagent">Добавить</button>
                        }
                    </form>
                    
                </div>
            </div>
            
        </div>

    </div>

    <script>

        function showTab(index) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-btn');

            // Скрыть все вкладки
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(button => button.classList.remove('active'));

            // Показать активную вкладку
            tabs[index].classList.add('active');
            buttons[index].classList.add('active');
        }

        ///////////////////////////////////////////////////////////////////////////

        function editRow(button) {
            const row = button.closest('tr'); // Находим строку таблицы
            const cells = row.querySelectorAll('td:not(.action-buttons)'); // Находим все ячейки в строке, исключая кнопки действий
            const isReagentTab = document.querySelector('h3').textContent.includes('Используемые реагенты');

            // Преобразуем только определенные поля для редактирования
            cells.forEach((cell, index) => {
                const currentValue = cell.textContent.trim();

                //if (isReagentTab) {
                    // Разрешаем редактировать только "Использованную массу" (3 столбец) и "Количество использованного реагента" (4 столбец)
                    if (index === 3 || index === 4) {
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.value = currentValue;
                        cell.innerHTML = '';
                        cell.appendChild(inputElement);
                    }
                // } else {
                //     Для других вкладок преобразуем все ячейки в поле ввода
                //     const inputElement = document.createElement('input');
                //     inputElement.type = 'text';
                //     inputElement.value = currentValue;
                //     cell.innerHTML = '';
                //     cell.appendChild(inputElement);
                // }
            });

            // Меняем текст на кнопке "Изменить" на "Сохранить"
            button.textContent = "Сохранить";
            button.onclick = () => saveRow(button);
        }

        function saveRow(button) {
            const row = button.closest('tr');
            const cells = row.querySelectorAll('td:not(.action-buttons)');
            const updatedValues = [];

            let invalidInput = false; // Флаг для проверки валидности данных

            // Получаем обновленные значения только из редактируемых полей
            cells.forEach((cell, index) => {
                if (index === 3 || index === 4) { // Обрабатываем только определенные столбцы
                    const input = cell.querySelector('input');
                    if (input) {
                        const value = input.value.trim();

                        if (index === 3) { // Проверка "Использованной массы"
                            const useMassValue = parseFloat(value.replace(',', '.') || '0');
                            if (useMassValue < 0) {
                                alert("Использованная масса не может быть отрицательной.");
                                invalidInput = true;
                                return;
                            }
                            updatedValues[index] = useMassValue.toString();
                        } else if (index === 4) { // Проверка "Количество использованного реагента"
                            const useCountValue = parseInt(value, 10);
                            if (useCountValue < 0 || !Number.isInteger(useCountValue)) {
                                alert("Использованное количество не может быть меньше 0 и должно быть целым числом.");
                                invalidInput = true;
                                return;
                            }
                            updatedValues[index] = useCountValue.toString();
                        }
                        input.value = updatedValues[index]; // Возвращаем корректное значение в input
                    } else {
                        updatedValues.push(cell.textContent.trim());
                    }
                } else {
                    updatedValues.push(cell.textContent.trim());
                }
            });

            if (invalidInput) return; // Прерываем выполнение, если данные невалидны

            // Подготовка данных для отправки на сервер
            const IdReagentExperiment = button.value; // ID реагента из кнопки
            const useMassValue = parseFloat(updatedValues[3]?.replace(',', '.') || '0'); // Значение "Использованная масса"
            const useCountValue = parseInt(updatedValues[4], 10); // Значение "Количество использованного реагента"

            fetch('/Add/UpdateExperiment', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idReagentExperiment: IdReagentExperiment,
                    UseMass: useMassValue,
                    UseCount: useCountValue
                })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(errorMessage => {
                            throw new Error(errorMessage);
                        });
                    } else {
                        // Если запрос успешен, блокируем редактирование
                        cells.forEach((cell, index) => {
                            if (index === 3 || index === 4) {
                                const input = cell.querySelector('input');
                                if (input) {
                                    cell.textContent = input.value.trim(); // Устанавливаем текст вместо input
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    alert(error.message);
                    // Если произошла ошибка, возвращаем значения input
                    cells.forEach((cell, index) => {
                        if (index === 3 || index === 4) {
                            const input = cell.querySelector('input');
                            if (input) {
                                input.value = updatedValues[index] || '';
                            }
                        }
                    });
                });

            // Возвращаем кнопку к состоянию "Изменить"
            button.textContent = "Изменить";
            button.onclick = () => editRow(button);
        }

        function saveForm(button) {
            // Получаем форму и поля из нее
            const form = button.closest('form');
            const formData = new FormData(form);
            const updatedValues = {};

            let invalidInput = false;

            // Проверка и сбор обновленных значений из всех полей формы
            formData.forEach((value, key) => {
                if (key === "ExperimentStartDate" || key === "ExperimentEndDate") {
                    // Преобразуем дату в корректный формат
                    //const dateValue = new Date(value);
                    //if (isNaN(dateValue)) {
                    //    alert(`${key} не является допустимой датой.`);
                    //    invalidInput = true;
                    //    return;
                    //}
                    //
                    updatedValues[key] =value; 
                } else if (key === "ExperimentResult" || key === "ExperimentStatus") {
                    // Преобразуем текстовые поля (при необходимости добавьте другие проверки)
                    updatedValues[key] = value.trim();
                } else if (key === "ExperimentName" || key === "ExperimentDescription") {
                    // Преобразуем текстовые поля (при необходимости добавьте другие проверки)
                    updatedValues[key] = value.trim();
                }
            });

            if (invalidInput) return;

            // Подготовка данных для отправки на сервер
            const formValues = {
                Name: updatedValues['ExperimentName'] || "",  // Если пусто, то "" (пустая строка)
                Description: updatedValues['ExperimentDescription'] || "",  // Пустая строка
                StartDate: updatedValues['ExperimentStartDate'] ? updatedValues['ExperimentStartDate'] : null,  // если пусто, передаем null
                EndDate: updatedValues['ExperimentEndDate'] ? updatedValues['ExperimentEndDate'] : null,  // если пусто, передаем null
                Result: updatedValues['ExperimentResult'] || "",  // Пустая строка
                Status: updatedValues['ExperimentStatus'] || ""  // Пустая строка
            };


            fetch('/Add/UpdateExperiment?handler=SaveDate', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formValues) // Здесь formValues - это данные, которые вы отправляете на сервер
             })
            //     .then(response => {
            //         if (!response.ok) {
            //             return Promise.reject('Ошибка сервера');
            //         }
            //         return response.json();  Обрабатываем ответ как JSON
            //     })
            //     .then(data => {
            //         Обрабатываем успешный ответ
            //         alert(data.message);  Здесь выводится сообщение из сервера
            //     })
            //     .catch(error => {
            //         Обработка ошибок
            //         alert(error);  Показываем ошибку
            //     });


            // fetch('/Add/UpdateExperiment?handler=SaveDate', {
            //     method: "POST",
            //     headers: {
            //         "Content-Type": "application/json"
            //     },
            //     body: JSON.stringify(formValues)
            // })
            //     .then(response => {
            //         if (!response.ok) {
            //             return Promise.reject('Ошибка сервера');
            //         }
            //         return response.json();  Обрабатываем ответ как JSON
            //     })
            //     .then(data => {
            //         Обрабатываем успешный ответ
            //         alert("Данные успешно обновлены");  Здесь выводится сообщение из сервера
            //     })
            //     .catch(error => {
            //         Обработка ошибок
            //         alert(error);  Показываем ошибку
            //     });
                // .then(response => response.ok ? response.json() : Promise.reject('Ошибка сервера'))
                // .then(data => {
                   
                //     alert("Данные успешно сохранены!");
                //     button.textContent = "Сохранено";
                //     button.disabled = true;
                // })
                // .catch(error => {
                //     alert(error);
                //     Object.keys(updatedValues).forEach(key => {
                //        const input = form.querySelector(`[name="${key}"]`);
                //        if (input) {
                //            input.value = updatedValues[key] || '';
                //        }
                //     });
                // });
        }

    </script>
</body>
</html>
